name: å…¨åœ‹é›»å­è¨‚å–®æª¢æŸ¥ç³»çµ±

on:
  workflow_dispatch: {}
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 09:05 åŸ·è¡Œï¼ˆUTC+8 = 01:05 UTCï¼‰
    - cron: "5 1 * * *"

jobs:
  order-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ğŸ›°ï¸ é€™å…©æ­¥å°±æ˜¯ä½ è¦çš„ã€Œå‡ºå£ IPã€èˆ‡ã€Œç›®æ¨™ç«™å¯é”æ€§ã€æª¢æŸ¥
      - name: Check outbound IP
        run: |
          echo "Outbound IP:"
          (curl -s https://ifconfig.me || curl -s http://ifconfig.me) || true

      - name: Probe vendor login page
        run: |
          set -e
          echo "Probing https://www.elifemall.com.tw/vendor/ ..."
          curl -I -L --max-time 20 'https://www.elifemall.com.tw/vendor/' || true

      # âœ… ç¢ºèª Secrets è‡³å°‘æœ‰å€¼ï¼ˆä¸æœƒé¡¯ç¤ºå…§å®¹ï¼Œåªå°é•·åº¦ï¼‰
      - name: Sanity check secrets (masked)
        run: |
          echo "USER_LEN=${#ELIFE_USERNAME}"
          echo "PASS_LEN=${#ELIFE_PASSWORD}"
          echo "GMAIL_ADDR_LEN=${#GMAIL_ADDR}"
          echo "GMAIL_APP_PW_LEN=${#GMAIL_APP_PASSWORD}"
        env:
          ELIFE_USERNAME: ${{ secrets.ELIFE_USERNAME }}
          ELIFE_PASSWORD: ${{ secrets.ELIFE_PASSWORD }}
          GMAIL_ADDR: ${{ secrets.GMAIL_ADDR }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # â–¶ï¸ åŸ·è¡Œä½ çš„æª¢æŸ¥ç¨‹å¼
      #   æŠŠ SCRIPT æ”¹æˆä½  repo å…§å¯¦éš›çš„ .py æª”ï¼ˆä¾‹ï¼šrequests_auto_order_check.pyï¼‰
      - name: Run order checker
        env:
          ELIFE_USERNAME: ${{ secrets.ELIFE_USERNAME }}
          ELIFE_PASSWORD: ${{ secrets.ELIFE_PASSWORD }}
          GMAIL_ADDR: ${{ secrets.GMAIL_ADDR }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        run: |
          set -e
          mkdir -p artifacts
          SCRIPT="requests_auto_order_check.py"   # â†â†â† é€™è¡Œæ”¹æˆä½ çš„æª”å
          echo "Running $SCRIPT ..."
          python "$SCRIPT"

      # â¤´ï¸ å¤±æ•—æ™‚æŠŠ artifactsï¼ˆä¾‹å¦‚ä½ ç¨‹å¼å­˜çš„ login æˆªåœ–/HTMLï¼‰ä¸Šå‚³ï¼Œæ–¹ä¾¿æ’éŒ¯
      - name: Upload debug artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts
          path: artifacts/**
          if-no-files-found: ignore
